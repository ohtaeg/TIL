# S3 (Simple Storage Service)
- 객체 스토리지 서비스
- 무제한 용량
- 버전 관리 기능
- Static Web 호스팅 가능
- **업로드, 업데이트, 삭제의 데이터 일관성 모델이 다름**
- 다른 유저/계정과 공유 가능
- 다른 Region으로 복제 가능
- 수명 주기 설정 가능
- 삭제 방지 기능 (MFA)
- 파일 전송 Transfer Acceleration 가능

<br>

## 객체 스토리지 서비스
- 객체는 파일로써 저장시 파일만 가능
  - 키를 가진다. => `파일의 full 경로`
    - ex) s3://my-bucket/`my_file.txt`
    - ex) s3://my-buckey/`folder/depth1/my_file.txt`
    - 키는 접두어와 객체 이름으로 구성된다.
      - ex) s3://my-buckey/`folder/depth1/my_file.txt`
      - prefix : `folder/depth1`
      - object name : `my_file.txt`
      - 버킷의 접두에 갯수는 제한되어있지 않다.
  - 파일 설치 불가
- 무제한 용량
  - 단 하나의 객체는 **0byte ~ 5TB**의 용량
  - 0byte ? -> 파일 내용은 없고 key만 있는 경우 (메타데이터)
  - 업로드 파일 갯수는 무제한
- Bucket 이라는 단위로 구분된다.
  - 디렉토리 개념
  - `Global Unique`
  - 버킷은 리전 리소스이다.
  - 대문자를 포함하지 말 것.
  - under score 사용 x
  - 길이는 3 ~ 63자
  - IP 주소가 아닐 것
  - 소문자 or 숫자로 시작할 것
  - Web Hosting 시 도메인과 Bucket 명이 같아야한다.
- 99.999999999% 내구성
  - 0.000000001% 확률로 파일을 잃어버릴 수 있다.
- 99.99% SLA 가용성 (티어에 따라 다름)
  - SLA 란?
    - Service Level Agreement (SLA), 즉 ‘서비스 수준 협약’
    - 합의된 서비스 수준을 달성하지 못할 경우 물어준다는 내용
  - 가용성과 내구성의 차이
    - 내구성은 파일 보관중 파일이 없어지냐 아니냐
    - 가용성은 서비스 중에 파일을 다운로드 받을 수 있는지 없는지
  
<br>

## S3 API
- 업로드
  - 업로드 성공시 HTTP 200 반환
  - 큰 용량의 파일 경우 Multipart Upload 가능 `(한번에 5GB 이상 업로드 불가능)`
    - 멀티 파트 : 큰 파일을 잘게 쪼개서 하나씩 업로드 한 후에 S3에서 합치는 것
    - 업로드가 중지되더라도 업로드를 계속할 수 있다.
    - 분산 업로드이기 때문에 속도가 빠르다.
    - **파일이 100MB를 초과하는 즉시 멀티파트 업로드를 권장한다.**
- 업데이트
- 삭제
- 다운로드시 Torrent 지원
  - 트래픽을 최소화하고 유저끼리 공유할 수 있도록 하는 방법
- Bucket 관련 API 지원 (조회, 생성, 삭제 등)

<br>

## S3 객체의 구성
- Key : 파일 이름
- Value : 파일 데이터
- Version Id : 파일의 버전 ID
- Metadata : 파일의 정보 데이터
- ACL : 파일의 권한을 담은 데이터
- Torrent : 토렌트 공유를 위한 데이터

<br>

## Version
- 모든 버전을 관리 (생성, 삭제, 업데이트 포함)
  - 기본적으로 비활성화 되어있기에 활성화를 해야함
  - 한번 활성화시 비활성화 불가능
  - 같은 키로 파일을 다시 업로드 하는 경우 기존 파일을 덮어쓴ㄴ게 아닌 새로운 버전을 생성하게 된다.
- 필요한 이전 버전으로 손쉽게 되돌릴 수 있다.
- 수명 주기 관리와 버저닝 연동 가능
- 버저닝을 활성화하기전에 버전 관리되지 않는 파일들은 버전이 null 이다.
- 버저닝을 중단하면 버전을 삭제하는 것이 아닌 파일이 버전을 할당받지 못하도록 한다.

<br>

## Static Hosting
- 기본적으로 파일은 두가지 웹 URL을 가지고 있다.
  1. https://`bucket-name`.s3.`region`.amazonaws.com/`keyname`
  2. https://s3.`region`.amazonaws.com/`bucket-name`/`keyname`
- Static Hosting 가능
  - www 에서 접근이 가능하도록 허용
  - HTML, JS 등으로 구성된 데이터가 변하지 않는 Static 사이트만 가능
    - 동적인 데이터는 AJAX로 해결 등
  - 호스팅 비용이 저렴
  - Serverless
- 웹사이트를 활성화했으나 설정된 버킷 정책이 없어서 버킷과 객체가 퍼블릭하지 않은 상태라면 403을 받는다.

<br>

## S3 일관성 모델 (Consistency Model)
- 20년 12월 이전
- Put
  - 파일을 올리고 성공한 후 읽기 가능
  - 같은 키에 대한 동시 요청은 먼저 Put한 요청이 우선권
- Update / Delete (최종 일관성, Eventual Consistency)
  - 파일 삭제/업데이트 후 일정 시간 후에 결과가 반영이 된다 (1초 미만)
  - 파일을 분산해서 저장하기 때문에 업데이트 내역이 모든 저장소에 도달하는데까지 시간이 걸린다.
  - 즉, 파일을 업데이트한 직후 동시에 누군가 읽었을 때 파일이 업데이트되지 않은 상태로 읽힐 수 있다.
  - 원자성 확보 불가능
- 20년 12월 부터 PUT or Delete 등 작업을 수행하고 나서 읽기를 수행하면 방금 작성한 객체를 볼 수 있다.
- 성능에 영향을 주지 않으며 무상 제공

<br>

## S3 Transfer Acceleration
- AWS 네트워크를 통해 각 Edge Location에서 더욱 빠른 업로드 가능
  - Edge Location : CloudFront와 같이 일정 지역에 빠른 엑세스를 위한 지역
  - AWS 네트워크를 사용하기 때문에 빠름
  
<br>

## S3 Athena
- S3를 SQL 언어로 조회할 수 있는 서비스
- SQL 쿼리 사용
- Serverless
- 로그를 조회하거나 분석하는데 주로 활용
- Elastic Search를 활용하는 방법도 있지만 비싸고, 서버를 호스팅 해야되기에 Athena는 쓴만큼만 비용한다.

<br>

## S3 퍼포먼스
- S3에서 첫 바이트를 얻기까지 100-200ms 정도로 지연 시간이 짧다.
- 초당 3,500개의 CRUD 작업을 수행 (고성능)
- SSE-KMS를 사용하는 경우 파일 업로드시 S3에서 GenerateDataKey를 호출
- SSE-KMS를 사용하는 경우 파일 다운로드시 S3에서 Decrypt KMS-API 호출
- 즉, 이 두가지 경우는 요청이 생기기에 많은 요청이 생기는 경우 KMS S3 성능에 영향을 줄수도 있다.
- 최적화를 위한 방법은
  - 멀티 파트 업로드를 권장한다. (100MB 이상)
  - S3 Transfer Acceleration와 호환 가능
  - 다운로드는 바이트 범위 가져오기를 이용한다.
    - 전체 검색으로 S3에 저장된 객체를 반환할 수 있듯이
    - 부분 객체 검색–GET 요청에 바이트 Range HTTP 헤더를 사용하여 Amazon S3에 저장된 객체에서 특정 바이트 범위를 검색할 수 있다.
    - 바이트 범위 요청의 일반적인 크기는 8MB 또는 16MB입니다.
    - 바이트 범위를 얻는데 실패하더라도 다시 시도하여 실패 복원성이 있다.
    - 파일의 몇 바이트를 가져오는 요청을 여러개 분할하여 요청한다고 가정할 떄, 병렬적으로 이루어진다.
    - 파일의 일부를 화수하는 경우 첫 50바이트가 파일의 메타정보를 알 수 있는 바이트라면 인덱스에도 활용할 수 있다.