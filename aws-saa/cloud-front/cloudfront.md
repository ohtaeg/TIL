# CloudFront
- 컨텐츠 전달 네트워크 (CND)
- Region이 필요없는 글로벌 서비스
- 엣지 로케이션에서 컨텐츠 분배 및 캐시가 되어 읽기 퍼포펀스 향상
- 216개 이상의 엣지 로케이션이 존재한다.
- DDoS 보호 제공
- 인증서롤 로드하여 외부 HTTPS 엔드 포인트를 노출하고 트래픽을 암호화 하는 경우 어플리케이션과 내부적으로 통신하게 해준다.

<br>

## Origins
- S3
  - 전서계 파일을 배포하고 엣지 로케이션에서 캐시할 때 사용
  - `Origin Access Identity (OAI)` 으로 CloudFront와 S3 보안을 강화한다.
    - CloudFront의 엣지 로케이션이 S3 버킷에 엑세스 하려면 CloudFront 오리진에 대한 `IAM` 역할인 OAI를 사용해야한다.
- Custom Origin (HTTP)
  - HTTP 프로토콜은 준수하는 모든것이 될 수 있다.
  - Application Load Balancer
    - 엣지 로케이션의 공용 IP를 허용해야한다.
  - EC2
    - 엣지 로케이션의 IP를 EC2 인스턴스 내로 혀용해아한다.
    - CloudFront에 접근할 수 있도록 보안 그룹이 모든 엣지 로케이션의 공용 IP 목록을 통해 EC2 인스턴스로부터 컨텐츠를 가져갈 수 있게 혀용해야한다.
  - S3 Website (정적 웹사이트로 버킷을 활성화해야함)
  - any HTTP Backend

<br>

## 동작 과정
1. 전세계에 존재하는 엣지로케이션들은 오리진(S3 등)과 연결되어 있다. 클라이언트가 CloudFront에 요청을 보낸다.
2. 엣지 로케이션이 해당 요청을 수신하여 오리진으로 전달한다.
3. 오리진은 엣지 로케이션에 회신하여 엣지 로케이션은 정의된 캐시 설정에 따라 회신 내용을 캐시한다.
4. 회신 내용을 클라이언트에게 반환한다.
5. 비슷한 요청을 다른 클라이언트가 요청을 하면 엣지 로케이션은 요청을 오리진으로 전달하기 전에 캐시부터 살펴본다.

<br>

## 지리적 엑세스 제한
1. Whitelist를 통해 이 리스트에 있는 허용된 국가의 사용자들만이 CloudFront에 엑세스 할 수 있다.
2. 블랙리스트를 만들어서 특정 국가의 사용자들이 엑세스할 수 없도록 할 수 있다.
3. 3rd Party의 데이터베이스를 사용하여 국가들을 허용할지 결정할 수 있다.
   - 디비에 국가-ip 정보를 매핑하는 정보를 읽어온다는 뜻인듯?
   - 특정 콘텐츠에 엑세스를 제한하도록 하는 저작권 법이 있을 때 사용할 수 있다.

<br>

## CloudFront vs S3 리전 복제 차이
- CloudFront
  - 엣지 네트워크를 사용
  - TTL에 맞게 파일이 캐시된다. (TTL : 데이터의 유효 기간, 정해진 유효기간이 지나면 데이터는 폐기된다.)
  - TTL이 하루일 수도 있다.
  - 컨텐츠가 약간 오래되어도 괜찮은 경우 (정적 컨텐츠에 적합)
- S3
  - 각 리전마다 복제가 가능하도록 설정해야한다.
  - 파일이 거의 실시간으로 업데이트 된다.
  - 읽기 전용이기 때문에 성능이 좋다.
  - 적은 수의 리전에서 낮은 지연 시간으로 사용이 가능해야하는 동적인 컨텐츠에 적합

<br>

## CloudFront Signed URL / Signed Cookies
- 전세계 프리미엄 사용자에게 유료 공유 컨텐츠를 배포하고자 할 때 유로 콘텐츠에 대한 엑세스를 제한할 수 있다.
- 누가 어떤 CloudFront에 접근하는지 알기 위해서 `서명된 url 이나 쿠키`를 사용할 수 있다.
  - 서명된 url 이나 쿠키는 정책을 연결하여 언제 만료가 되고, 이 데이터에 엑세스할 수 있는지 알 수 있다.
  - 데이터를 접근하기 위해 IP 범위를 지정할 수 있다.
  - 어떤 AWS 계정이 서명된 URL을 생성할 수 있는지를 의미할 수 있도록 서명자도 지정해야한다.
- URL은 얼마나 유효해야할까?
  - 영화, 음악같은 컨텐츠는 몇 분 정도로 짧아도 될 것이다.
  - 장기간 관리해야하는 비공개 콘텐츠 같은 경우 수년간 설정할 수 있다.

<br>

## 서명된 URL과 쿠키의 차이
- 서명된 URL
  - 개별 파일에 대한 엑세스를 준다.
  - 파일별로 하나의 URL이 있다.
  - 파일이 백 개면 백개의 URL이 있다.
- 서명된 쿠키
  - 다수의 파일에 엑세스를 준다.
  - 다수 파일에 서명된 쿠키는 하나다.
  - 쿠키는 재사용이 가능하다.

<br>

# 서명된 CloudFront URL 과 미리 서명된 S3 URL 차이
- CloudFront Signed URL
  - 어떤 오리진이든 상관없이 엑세스를 허용한다.
  - 계정 내 키 페어이기 때문에 루트만 관리할 수 있다.
  - IP, path, 날짜, 만료 등으로 필터링할 수 있다.
- S3 Pre-Signed URL
  - IAM을 통해 URL에 서명하면 IAM 주체의 IAM 키를 사용합니다.
  - 해당 URL을 가진 사람은 같은 권한을 가지게 된다.

<br>

## CloudFront 가격
- 엣지 로케이션에 따른 데이터 전송 비용이 다를 것이다.
- 지리적 위치에 따라 요금이 달라진다.
- 많은 데이터가 전송될수록 가격이 낮아진다.
- 엣지 로케이션을 줄여서 가격등급을 조정할 수 있다.
  - Price Class All : 모든 지역을 제공하며, 최상의 성능이지만 비용이 비싸다.
  - Price Class 200 : 가장 비싼 지역을 제외한 대부분의 지역을 제공해준다.
  - Price Class 100 : 가장 저렴한 지역만을 제공한다.

<br>

## CloudFront 다중 오리진과 오리진 그룹
`다중 오리진`
- 컨텐츠 유형이나 경로에 따라 CloudFront를 거치는 라우트나 경로를 리다이렉트하여
  다른 종류의 origin들로 라우팅할 수 있다.
- 이미지용 경로나 API용 경로 등 어느 경로건 클라우드프론트에서는 정해진 경로를 통해
  캐시 작업을 설정할 수 있다.
  - 만약 API 경로라면 로드 밸런서로, 이미지용 경로라면 S3 버킷으로 리다이렉트 할 수 있다.

  
`오리진 그룹`
- **고가용성을 증가**시키고 한 오리진에서 장애가 발생한 경우 `장애 조치`를 가능하게 해준다.
- 따라서 오리진 그룹은 하나의 메인 오리진과 하나의 보조 오리진으로 구성된다.
  - 메인 오리진에서 장애가 발생하면 CloudFront가 보조 오리진으로 대체된다.

<br>

## CloudFront Field Level Encryption
- 어플리케이션 스택?을 통해 민감한 정보를 보호하는 기능
- HTPS를 사용과 더불어 추가적인 보안을 더해준다.
- 사용자가 민감한 정보를 전송할 때마다 엣지 로케이션이 이를 암호화한다.
  - `개인 키`에 대한 권한을 지닌 사용자(웹서버 등)만이 이 정보를 해독할 수 있다. `비대칭 암호화`
    - CloudFront나 ALB 등은 해석을 못한다.
  - CloudFront로 보내는 POST 요청의 경우 암호화를 원하는 필드를 최대 10개까지 지정할 수 있다.
  - 이 필드를 해독할 `공개키`도 엣지 로케이션에서 함께 지정된다.