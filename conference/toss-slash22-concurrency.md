# 토스 애플 한 주가 고객에게 전달되기까지

- 해당 [컨퍼런스 영상](https://www.youtube.com/watch?v=UOWy6zdsD-c&t=55s&ab_channel=%ED%86%A0%EC%8A%A4)을 보고 좋은 인사이트가 되어 정리

- 토스 증권에서는 다양한 곳에서 고객의 잔고를 갱신하는 트랜잭션들이 발생한다.
- 그렇기에 안전하게 동시성을 제어해야한다.

![image1](img/toss-slash22-concurrency-1.png)

- 자동 매매는 여러 테이블에 대한 삽입 및 갱신이 일어나는 트랜잭션이기에 테이블 하나하나 모두 락을 잡아버린다면 성능 저하와 데드락 지옥을 피할수가 없다.
- 데드락을 피할수가 없다고?
    - 데드락은 서로 다른 트랜잭션들이 서로에 대한 락을 소유한 상태로 대기 상태가 되어 더 이상 요청에 대한 응답을 수행하지 못하는 상황을 말한다.
    - 만약 insert 하는 테이블에 락이 걸리고 update한 테이블에 락이 걸린 상태에서 서로 교차해서 수행을 해야하는 경우 걸릴 수 있다고 생각한다.

<br>

- 보통 이런 경우 **락을 위한 테이블을 별도로 두게 되고 락 테이블을 통해 트랜잭션 동시성을 제어한다.**

![image2](img/toss-slash22-concurrency-2.png)

- 토스는 **Redis 기반 분산락**을 이용해 해결하고 있다.
- Redis 분산락을 사용함으로써 DB 락을 강제하지 않게 된다.
- Redis 분산락을 사용하게 되면 여러 서버들에서 많은 요청들이 발생하기 때문에 높은 처리량이 보장되어야 한다.
  - Redis는 메모리 기반 저장소다보니 RDBMS AccountLock에 비해 보다 높은 처리량을 제공하는 것 역시 장점이다.

<br>

- 분산락은 모든 서버가 공통으로 사용하기 때문에 하나의 트랜잭션이 무한정 락을 소유하고 있을 경우 다른 서버들의 요청이 무한정 대기할 수 있다.
- 그렇기에 분산락은 적절한 타임아웃 설정이 필요하다.
- 락 타임아웃은 락을 획득하기 위해 기다리는 시간을 정해놓는다는 것을 의미한다. 
  - 락 타임아웃을 건 쓰레드가 주어진 시간을 소진하기까지 락을 획득하지 못하면 쓰레드는 이 락을 포기한다.

(이 부분부터 다시 정리 필요)
- 조심해야할 부분은 분산락 타임아웃은 의도대로 동작하지 않을 수 있다.
    - 분산락 타임아웃이 지나 락 해체가 되었지만 트랜잭션이 끝나질 않아서 다른 트랜잭션과 경합이 발생할 수 있다.

![image3](img/toss-slash22-concurrency-3.png)

1. 0초에 T1과 T2 트랜잭션이 동시에 발생했다.
2. 그리고 T1이 락을 획득하고 T2가 락을 대기하는 상태가 되었다고 가정하자.
3. 2초뒤에 T1은 락 타임아웃으로 락이 해제되었고 T2는 락을 획득하고 500원을 출금하여 잔고가 1,500원이 남게된다.
4. 그리고 2초뒤인 4초에 지연된 T1 트랜잭션이 락 획득을 다시 시도하고 락 획득이 되어 트랜잭션 처리가 완료되어 2,000원을 출금하게 되면 고객의 돈이 맞질 않게 되는 갱신 유실이 발생하게 된다.
   - 이때 lock 획득이 되는지 납득이 되질 않음

<br>

- 갱신 유실 방지를 하는 방법은 아래 방법들로 방지가 가능하다.
1. 원자적인 연산 사용
2. 명시적 잠금
3. 갱신 손실 자동 감지
4. CompareAndSet 연산

- 명시적 잠금 방법인 2번은 여러 테이블을 갱신하는 트랜잭션에서는 비용이 매우 비싸고
- 원자적 연산 사용과 갱신 손실 자동 감지는 dbms에 의존적이기 때문에 ORM과 궁합이 좋지 않다.
- 토스 증권은 CAS 연산을 통해 갱신 유실을 방지하고 있다. (6:40)