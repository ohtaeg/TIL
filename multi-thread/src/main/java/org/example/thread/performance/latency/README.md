# 성능 및 지연시간 최적화
- 성능은 시나리오에 따라 다르게 측정될 수 있다.
- 트레이딩 시스템 같은 경우, 성능을 측정하는 기준은 `지연 시간`이다.
  - 지연 시간은 작업 하나의 완료 시간으로 측정된다.
  - 즉, 트랜잭션이 빠를수록 어플리케이션 성능이 더 중요해진다.
- 비디오 플레이어는 프레임 레이트가 지표가 된다.
- 머신러닝 같은 경우는 `처리량`이 메트릭이 된다.
  - 처리량은 일정 시간동안 완료한 작업의 양으로 측정된다.
- 이 중에서 `지연 시간`과 `처리량`을 중점으로 생각해보자.

<br>

- 멀티 스레드 프로그래밍에서 `지연 시간`과 `처리량`을 어떻게 줄일수 있을까?
- 하위 작업들을 병렬로 실행되도록 다른 스레드에 스케줄랑히여 `지연 시간`을 하위 작업의 갯수로 나누면 될 것 같다.
- 그렇다면 하위 작업들을 몇개까지 나눌 수 있는가?
  - 컴퓨터의 스레드 갯수는 코어 갯수와 최대한 비슷하면 좋다. 
    - 그렇게 되면 모든 스레드가 인터럽트 없이 서로 다른 코어에서 최적의 실행이 가능해짐, 모든 스레드 상태가 Runnable
    - 스레드가 추가가 되면 컨텍스트 스위칭, 캐시 성능 저하, 메모리 소비가 증가한다.
- 어떤 작업이든 원하는 만큼 나눌 수 있을까? 분할했다가 합치게 되면 대가가 없을까? 
  - 스레드 생성 비용, 스레드에 작업을 전달/시작하는 비용 등등이 발생

<br>

- 이미지 프로세싱 예를 통해 시퀀셜하게 작성한 성능과, 분할해서 멀티 스레드로 병렬 실행한 성능을 비교해보자.
- 우선 디지털 사진은 픽셀이라는 단일 컬러 포인트로 구성된다.
- 각 픽셀은 ARGB로 불리는 네가지 바이트로 표현된다.
  - A : Alpha, 투명성
  - R : Red
  - G : Green
  - B : Blue
- 각 바이트 컴포턴트로 색을 조합할 수 있다.
- 사진의 색상을 recoloring 알고리즘을 싱글 스레드로 시퀀셜하게 구현 및 멀티 스레드로 병렬 처리하도록 구현해보고 시간 차이를 비교해보자.
- 싱글 스레드
  ```
  699ms
  ```
- 멀티 스레드
  ```
  스레드 2개
  468ms
  
  스레드 3개
  평균 300 후반대
  
  스레드 6개
  230 ~ 310
  
  스레드 7개
  240 ~ 310ms
  
  스레드 12개
  240 ~ 310ms
  ```
- 측정 결과 물리 코어 갯수(6)만큼 스레드 수를 늘리면 지연시간이 개선되었다.
- 가상 코어 갯수 만큼 스레드 수를 늘리면 물리코어 갯수 수 만큼의 성능과 큰 차이는 없었다.
  - 가상 코어는 서로 리소스를 공유하기 때문에 
- 스레드 수를 더 늘리면 더이상 개선점은 없었다.
- 멀티 스레드를 적용해 얻은 속도 개선은 약 70%

<br>

- 요약
- 문제를 여러 테스크로 분할해 멀티 스레드로 실행하면 속도와 성능을 크게 개선할 수 있다.
- 스레드 수가 코어보다 많으면 스레드 생성에 대한 비용도 들고 블로킹 호출이 없고 단순한 계산만 하는 문제에 역효과를 낳는다.
- 분할해서 멀티 스레드로 처리해서 효과를 보려면 문제 크기가 커야한다.