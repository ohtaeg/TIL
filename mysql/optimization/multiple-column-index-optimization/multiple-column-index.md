# 복합 인덱스 최적화
- 다중 컬럼 인덱스 == 복합 인덱스, 여러 컬럼을 조합한 인덱스를 뜻함
- 복합 인덱스의 중요한 점은 **명시된 컬럼 순서로 정렬 되는 것**
- 복합 인덱스는 컬럼 순서에 따라 성능이 급격하게 차이가 난다.

<br> 

- 예로 (A, B) 컬럼이 복합 인덱스로 되어 있는 경우, 데이터는 A 기준으로 정렬되어 있고 이후 B 기준으로 정렬되어 있다.
  - B 조건 만으로 데이터를 찾는 경우 인덱스 풀스캔 발생
  - 또한 선행된 컬럼을 조건절에 사용하지 않으면 인덱스 풀스캔 발생

<br>

- 복합 인덱스를 설계하는 일반적인 기준은 `카디널리티`이다.
- **`카디널리티`가 높은 칼럼을 복합 인덱스의 선행 컬럼으로 한다.**
  - `카디널리티`가 높다는 뜻은 유니크한 값의 갯수가 많다는 뜻이다.

<br>

- 중요한건 카디널리티만 고려하지 않아야 한다!!!!!
1. **자주 사용하는 쿼리가 무엇인지 파악**하여 해당 쿼리들이 효율이 좋도록 디자인해야한다.
    - 예로 어플리케이션에서 A라는 컬럼이 있는데 카디널리티가 낮다.
    - 하지만 A 컬럼을 단독으로 사용하는 쿼리들이 많다면 카디널리티가 좀 떨어지더라도 복합 인덱스의 선행 컬럼으로 두는 것도 좋은 방법이 된다.
2. **조인에 자주 사용되는 컬럼**이라면 복합 인덱스의 선행 컬럼으로 두는 것도 좋은 방법이 된다.
3. 인덱스의 선행 컬럼이 범위 기반의 쿼리로 많이 사용되는지 고려해야한다.
   - 선행 컬럼이 카디널리티가 높더라도 범위 기반으로 탐색이 이루어지면 **많은 범위의 탐색이 이루어질 수 있기 때문에** <br> 
   **선행 컬럼으로 적합하지 않을 수 있다.**
4. 인덱스 설계 후 사후 처리
   - 인덱스가 잘못 설계되어 슬로우 쿼리가 발생될 수 있다.

<br>

## 인덱스 통계 방법
- 이미 인덱스가 구축되어 있다면 인덱스 통계 테이블(`innodb_index_stats`)을 통해 확인할 수 있다.
  - 옵티마이저는 최적의 실행계획을 세우기 위해 인덱스 통계 정보를 의존하게 되는데, innodb_index_stats 테이블에서 해당 정보를 얻는다.
- 아직 인덱스를 생성하지 않았다면 8.0 이상부터 히스토그램을 통해 확인할 수 있다.
```sql
ANALYZE TABLE table_name UPDATE HISTOGRAM ON column_name WITH 100 BUCKETS;
```
- 히스토그램은 자동으로 수집되지 않기 때문에 ANALYZE TABLE 명령을 통해 정보를 수집해야한다.
- 다만 [공식 레퍼런스](https://dev.mysql.com/doc/refman/8.0/en/analyze-table.html)에서 해당 명령어는 Lock이 걸릴 수도 있다고 안내가 나와있으니 조심해서 사용하자.
    > During the analysis, the table is locked with a read lock for InnoDB and MyISAM.



## 복합 인덱스에 너무 많은 컬럼이 설정된 경우
- 복합 인덱스에 많은 컬럼이 설정되어 있으면 성능이 안좋을 수 있다.
- 그런 경우, 여러 컬럼을 조합해서 `hashed 컬럼`을 만들어 인덱스로 만들어서 해결할 수 있다.
```sql
SELECT *
  FROM table_name
 WHERE hash_col = MD5(CONCAT(val1, val2))
   AND column_1 = val1
   AND column_2 = val2 
```
- 해시드 컬럼은 사용하고 있는 컬럼을 모두 조합한 후 해시 함수를 적용한 컬럼이다.
- 해시드 컬럼을 만들고 인덱스에 적용하면 단 하나의 컬럼만으로 인덱스 검색을 하게 되어 성능적으로 이득볼 수 있다.