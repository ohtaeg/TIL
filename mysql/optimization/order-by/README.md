#  Order by Optimization
- 인덱스 유무에 따른 정렬시 최적화 하는 방법

## 인덱스 유무에 따른 Order By의 동작
- ORDER BY 절에 명시된 컬럼에 인덱스가 있으면, MySQL 엔진은 이미 정렬된 데이터를 사용하기 때문에 추가적인 정렬 작업이 필요 없어진다.
- 인덱스가 없는 경우 `filesort` 방식으로, 임시 테이블을 사용해 정렬 작업을 수행한다.
  - 정렬되어야하는 데이터가 적다면 메모리 수준에서 sort buffer를 통해 정렬을 한다.
  - 정렬되어야하는 데이터가 많다면 (sort buffer에 담을 수 없을 정도면) <br> 데이터들을 쪼개서 디스크에 저장한 후 각각 정렬하고 합치는 식
- 특정 쿼리의 order by 절이 인덱스를 사용했는지, filesort를 이용하고 있는지 여부를 확인하기 위해 EXPLAIN 명령어를 통해 알 수 있다.
  - 실행 계획에 extra 컬럼에 using filesort가 있다면 filesort를 사용한 것
  - 실행 계획에 key 컬럼에 인덱스가 출력되었다면 인덱스를 이용해 정렬을 처리했다는 것

### SORT BUFFER
- MySQL에서는 데이터를 정렬하기 위해 별도의 메모리 공간을 추가 할당하는데 이때 사용되는 메모리가 Sort buffer이다.
- 정렬이 필요할 경우에만 할당되며, 쿼리 실행이 완료되면 시스템으로 즉시 반납된다.
- 임시 테이블은 메모리에 생성될 수도 있고 디스크에 생성될 수 있는데 디스크에 생성되었을 때는 정렬을 위해 메모리에 비해 성능이 훨씬 떨어지는 디스크 I/O가 빈번하게 일어나게되어 오래 걸린다는 얘기다.
- Soft buffer의 크기는 시스템 설정 변수인 `sort_buffer_size`로 조정 할 수 있으며 byte 단위로 표시된다.
  - 기본 사이즈는 262 KB 이다.
- file sort가 발생했는데 메모리 수준에서 정렬을 하는지, 디스크에서 정렬을 하는지는 `sort_merge_passes` 변수를 통해 알 수 있다. 

<br>

- 만약 정렬을 해야하는 레코드 건수가 소트 버퍼로 할당된 공간보다 크다면
1. 디스크에서 조건에 맞는 데이터를 읽고
2. 정렬해야할 레코드를 여러 조각으로 나눠서 sort buffer에서 정렬을 수행하고
3. 결과에 대해 Disk에 임시 저장
4. 다음 레코드를 가져와서 sort buffer에서 정렬을 수행하고
5. 다시 디스크에 임시저장

- 각 버퍼 크기 만큼씩 정렬된 레코드를 다시 병합하며 정렬을 수행하게 되고, 이 병합 작업을 `multi merge`라 한다.
- 수행된 multi merge 횟수는 `sort_merge_passes`라는 세션 변수에 누적된다.
  - 정렬 후 `sort_merge_passes` 변수 값이 증가했다면 디스크에서 정렬을 수행핬다는 뜻이다.

<br>

## Order by 최적화 전략
- 기본적으로 order by 절을 사용하는 경우 인덱스를 사용하는 것이 좋다.
- 특히 limit절과 함께 사용되면 더 좋다. 인덱스가 있다면 정렬 작업이 필요 없어지고 필요한 만큼 읽고 처리를 중단하지만
- 인덱스가 없다면 전체 데이터를 정렬한 후 limit 절에 명시된 수만큼 추출해야되기 때문에 성능차이가 있을 수 있다.

## Order by 최적화 전략 #1. filesort 튜닝
1. sort_buffer_size 튜닝
  - filesort는 임시테이블에 정렬할 데이터를 기록하고 sort buffer를 통해 정렬을 수행한다.
  - 정렬해야 되는 데이터가 많다면 디스크 수준에서 정렬을 해야되기 때문에 성능이 안나올 수도 있다.
  - 이런 경우 `sort_buffer_size`를 늘리면 디스크에서 정렬하는 부분을 최소화 할 수 있다.
  - 다만 buffer size를 늘리는 방법은 OS 메모리 부족현상을 겪을 수 있는 점을 고려해야한다.
  - 512K ~ 1MB가 적당(P334)
  - sort_buffer_size를 크게한다고 해서 빨리 지지는 않지만, **DISK I/O의 횟수를 줄일수 있다.**
   
2. 정렬 알고리즘
- filesort는 내부적으로 `single-pass` 와 `two-pass` 방식으로 정렬을 수행한다.